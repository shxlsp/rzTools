<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>贪吃蛇</title>
    <style>
        #es{
            width: 80vw;
            height: 80vh;
            margin: 20px auto;
            border: 2px solid black;
            position: relative;
        }
        #option{
            width: 80vw;
            margin: 0 auto;
        }
        #startBtn{
            cursor: pointer;
            user-select: none;
            float: left;
        }
        #es-body{
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .bodyBox{
            position: absolute;
            top: 0;
            left: 0;
            width: 10px;
            height: 10px;
            background: #ccc;
        }
        .headBox{
            position: absolute;
            background: crimson;
        }
        .food{
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: rgb(7, 25, 180);
        }
    </style>
</head>
<body>
    <div id="es">
        <div id="es-body">

        </div>
    </div>
    <div id="option">
        <div id="startBtn">开始游戏</div>

    </div>
    <script>
        document.querySelector('#startBtn').onclick = function(){
            console.log( 123123 );
            startFun();
        }
        var oriented = 'right',
            intervalId = '',
            createFoodTimeoutId = '',
            timeRandom = 2000,
            foodNum = 5,
            pzArr = [];
        pzArr.push(wall);
        pzArr.push(eatSelf);
        pzArr.push(eatFood);
        initTcs('#es-body',3)
        function initTcs( box, initLen ){
            var bodys = document.querySelectorAll('.bodyBox');
            len = bodys.length;
            for( var n = 0; n < len; n++){
                bodys[n].remove();
            }
            var box = document.querySelector(box);
            var headBox = document.createElement('div');
            headBox.classList.add('headBox');
            headBox.classList.add('bodyBox');
            box.appendChild(headBox);
            if( initLen ){
                headBox.style.left = ( initLen - 1 ) * 10 + 'px';
                for( let i = initLen - 2; i >= 0 ; i-- ){
                    box.appendChild( createBody( i * 10 ) );
                }
            }
        }

        function createBody( left, top ){
            var bodyBox = document.createElement('div');
            bodyBox.classList.add('bodyBox');
            bodyBox.style.left = left+'px';
            top ? bodyBox.style.top = top+'px': '';
            return bodyBox;
        }

        function startFun(){
            window.onkeydown = function(e){
                switch (e.keyCode) {
                    case 38:
                        if( oriented === 'down' ){
                            return;
                        }
                        oriented = 'top';
                        break;
                    case 40:
                        if( oriented === 'top' ){
                            return;
                        }
                        oriented = 'down';
                        break;
                    case 37:
                        if( oriented === 'right' ){
                            return;
                        }
                        oriented = 'left';
                        break;
                    case 39:
                        if( oriented === 'left' ){
                            return;
                        }
                        oriented = 'right';
                        break;
                    default:
                        return;
                }
                //keyCode 38 up
                //keyCode 40 down
                //keyCode 37 left
                //keyCode 39 right
                move();
            }
            positionRe();
            oriented='right';
            startTimeInterval();
            rollTimeFood();
        }

        function endFun(){
            window.onkeydown = null;
            clearInterval(intervalId);
            clearTimeout(createFoodTimeoutId);
            delFood();
            initTcs('#es-body',3);
            positionRe();
        }

        function delFood(){
            var food = document.querySelectorAll('.food');
            food.forEach(item=>item.remove())
        }

        //重置位置
        function positionRe(){
            var bodyBox = document.querySelectorAll('.bodyBox'),
                width = bodyBox[0].offsetWidth,
                len = bodyBox.length;
            for( var i = 0; i < len; i++ ){
                var key = len-1-i;
                bodyBox[key].style.left = i * width +'px';
                bodyBox[key].style.top = 0;
            }
        }

        function startTimeInterval(){
            intervalId = setInterval( move, 200);
        }

        function move(){
            var bodys = document.querySelectorAll('.bodyBox'),
                boxs = document.querySelector('#es-body'),
                len = bodys.length,
                itemWidth =  bodys[0].offsetWidth,
                itemHeight =  bodys[0].offsetHeight,
                itemLeft = bodys[0].offsetLeft,
                itemTop = bodys[0].offsetTop;
            switch (oriented) {
                case 'right':
                    //水平加
                    bodys[len-1].style.left = itemLeft + itemWidth + 'px';
                    bodys[len-1].style.top = itemTop + 'px';
                    break;
                case 'left':
                    //水平减
                    bodys[len-1].style.left = itemLeft - itemWidth + 'px';
                    bodys[len-1].style.top = itemTop + 'px';
                    break;
                case 'down':
                    //垂直加
                    bodys[len-1].style.top = itemTop + itemHeight + 'px';
                    bodys[len-1].style.left = itemLeft + 'px';
                    break;
                case 'top':
                    //垂直减
                    bodys[len-1].style.top = itemTop - itemHeight + 'px';
                    bodys[len-1].style.left = itemLeft + 'px';
                    break;
            }
            bodys[0].classList.remove('headBox');
            bodys[len-1].classList.add('headBox');
            boxs.insertBefore( bodys[len-1], bodys[0] );
            pz();
        }

        function pz(){
            var len =  pzArr.length;
            for( var i = 0; i < len; i++ ){
                switch (pzArr[i]()) {
                    case 'end':
                        endFun();
                        //TODO
                        //结束画面
                        break;
                
                    default:
                        break;
                }
            }
        }
        
        //围墙碰撞
        function wall(){
            var fatherBody = document.querySelector('#es-body'),
                headBox = document.querySelector('.headBox'),
            left = fatherBody.offsetLeft,
            top = fatherBody.offsetTop,
            width = fatherBody.offsetWidth,
            height = fatherBody.offsetHeight,
            litLeft = headBox.offsetLeft,
            litTop = headBox.offsetTop,
            litWidth = headBox.offsetWidth,
            litHeight = headBox.offsetHeight,
            leftMin = litLeft < left,
            leftMax = litLeft + litWidth > left + width,
            topMin = litTop < top,
            topMax = litTop + litHeight > top + height;
            if( leftMin || leftMax || topMin || topMax ){
                //GG
                return 'end';
            }
            return true;
        }

        //自杀碰撞
        function eatSelf(){
            var bodys = document.querySelectorAll('.bodyBox'),
                head = document.querySelector('.headBox'),
                len = bodys.length;
            for( var i = 0; i < len; i++ ){
                if( !bodys[i].classList.contains('headBox')){
                    if( collision( bodys[i], head ) ){
                        return 'end';
                    }
                }
            }
        }

        //食物碰撞
        function eatFood(){
            var food = document.querySelectorAll('.food'),
                head = document.querySelector('.headBox'),
                bodys = document.querySelectorAll('.bodyBox'),
                box = document.querySelector('#es-body'),
                len = food.length,
                bodysLen = bodys.length;
            for( var i = 0; i < len; i++ ){
                if( collision( food[i], head ) ){
                    var left = bodys[bodysLen-1].offsetLeft;
                    var top = bodys[bodysLen-1].offsetTop;
                    box.appendChild( createBody( left, top ) );
                    food[i].remove();
                    return;
                }
            }
        }

        //碰撞检测
        function collision( box1, box2 ){
            var box1Left = box1.offsetLeft,
                box2Left = box2.offsetLeft,
                box1Top = box1.offsetTop,
                box2Top = box2.offsetTop,
                box1Width = box1.offsetWidth,
                box2Width = box2.offsetWidth,
                box1Height = box1.offsetHeight,
                box2Height = box2.offsetHeight,
                leftBoom = false,
                topBoom = false;0
            // //水平碰撞检测
            // if( box1Left + box1Width <= box2Left + box2Width && box1Left + box1Width >= box2Left ){
            //     leftBoom = true
            // }
            // //垂直碰撞检测
            // if( box1Top + box1Height <= box2Top + box2Height && box1Top + box1Height >= box2Top ){
            //     topBoom = true
            // }
            // if( leftBoom && topBoom ){
            //    if( ( box1Left + box1Width - box2Left ) * ( box2Top + box2Height - box1Top ) ){
            //        return 'end'
            //    }
            // }

            if( box1Left === box2Left && box1Top == box2Top ){
                return 'end'
            }
        }

        function rollTimeFood(){
            createFoodTimeoutId = setTimeout(() => {
                var relNum = Math.ceil( Math.random()*foodNum );
                for( let i = 0; i < relNum; i++ ){
                    createFood();
                }
                rollTimeFood()
            }, Math.ceil( Math.random()*timeRandom ));
        }

        function createFood(){
            var food = document.createElement('div'),
                foodBox = document.querySelectorAll('.food'),
                box = document.querySelector('#es-body')
            food.classList.add('food');
            var left = box.offsetLeft,
                top = box.offsetTop,
                width = box.offsetWidth,
                height = box.offsetHeight;
            //10
            var leftTopObj = randomLeftTop( foodBox, left, top, width, height );
            food.style.left = leftTopObj.left + 'px';
            food.style.top = leftTopObj.top + 'px';
            box.appendChild(food);
        }

        function randomLeftTop( foodBox, left, top, width, height ){
            var len = foodBox.length;
            var foodLeft = left + parseInt(parseInt( width / 10 ) * Math.random()) * 10;
            var foodTop = top + parseInt(parseInt( height / 10 ) * Math.random()) * 10;
            for( var i = 0; i < len; i++ ){
                if( foodBox[i].offsetLeft === foodLeft && foodBox[i].offsetHeight === foodTop ){
                    return randomLeftTop(foodBox);
                }
            }
            return {left: foodLeft, top: foodTop }
        }
    </script>
</body>
</html>